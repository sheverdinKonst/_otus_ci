# Стандарты C

![To paraphrase a famous Soviet statesman, the fact that you can read and write correct C++ is not your achievement, but a committee’s oversight.](commitee.png)

[60 минут]::
## История стандартов C
[The Development of the C Language, Dennis M. Ritchie](https://port70.net/~nsz/c/c89/dmr_the_development_of_the_c_language.pdf)

[History of C - cppreference.com](https://en.cppreference.com/w/c/language/history)

[Language Standards Supported by GCC (Using GCC)](https://gcc.gnu.org/onlinedocs/gcc/Standards.html)

* **1978**: [K&R C](https://ru.wikipedia.org/wiki/Язык_программирования_Си_(книга))
  ```c
  main(argc, argv)
  int argc;
  char** argv;
  {
      printf("Hello world!\n");
      return 0;
  }
  ```
* **1989**: [ANSI X3.159-1989 / ISO/IEC 9899:1990](https://port70.net/~nsz/c/c89/c89-draft.html), `-std=c89` / `-std=c90`
  * codified existing practices
  * new features: `volatile`, `enum`, `signed`, `void`, [locales](https://en.cppreference.com/w/c/locale)
  * from C++: `const`, function prototypes
* **1995**: ISO/IEC 9899 AM1, `-std=c95`
  * [`__STDC_VERSION__`](https://en.cppreference.com/w/c/preprocessor/replace#Predefined_macros)
  * [wide and multibyte character support](https://en.cppreference.com/w/c/string/wide) (`wctype.h`, `wchar.h`, additions and changes to stream I/O, etc)
  * [digraphs](https://en.cppreference.com/w/c/language/operator_alternative), `iso646.h`
* **1999**: [ISO/IEC 9899:1999](https://port70.net/~nsz/c/c99/n1256.pdf), `-std=c99`
  * new features:
     * [`bool`](https://en.cppreference.com/w/c/types/boolean), [`long long`](https://en.cppreference.com/w/c/language/type)
     * [`stdint.h`, `inttypes.h`](https://en.cppreference.com/w/c/types/integer)
     * [`restrict`](https://en.cppreference.com/w/c/language/restrict)
     * [compound literals](https://en.cppreference.com/w/c/language/compound_literal)
     * [variable length arrays](https://en.cppreference.com/w/c/language/array#Variable-length_arrays)
     * [flexible array members](https://en.cppreference.com/w/c/language/struct#Explanation)
     * [designated initializers](https://en.cppreference.com/w/cpp/language/aggregate_initialization#Designated_initializers)
     * [variadic macros](https://en.cppreference.com/w/c/preprocessor/replace)
     * [complex numbers](https://en.cppreference.com/w/c/language/arithmetic_types#Complex_floating_types)
     * trailing comma in enumerations
       ```c
       enum color
       {
           RED,
           GREEN,
           BLUE,  /* invalid in C90, valid in C99 */
       }
       ```
     * [`STDC_*` pragmas](https://en.cppreference.com/w/c/preprocessor/impl#Standard_pragmas)
     * [`__func__`](https://en.cppreference.com/w/c/language/function_definition#func)
     * [hexadecimal floating point format (%a), `hh` and `ll` length specifiers](https://en.cppreference.com/w/c/io/fprintf), monetary formatting in [`lconv`](https://en.cppreference.com/w/c/locale/lconv), null return of [`tmpnam`](https://en.cppreference.com/w/c/io/tmpnam), null pointer in [`setvbuf`](https://en.cppreference.com/w/c/io/setvbuf), POSIX-like [`strftime`](https://en.cppreference.com/w/c/chrono/strftime) specifiers
     * [`isblank`](https://en.cppreference.com/w/c/string/byte/isblank)
     * [`va_copy`](https://en.cppreference.com/w/c/variadic/va_copy)
     * [`snprintf`](https://en.cppreference.com/w/c/io/fprintf)
     * [`_Exit`](https://en.cppreference.com/w/c/program/_Exit)
     * [`fenv.h`](https://en.cppreference.com/w/c/numeric/fenv)
     * [`tgmath.h`](https://en.cppreference.com/w/c/numeric/tgmath)
  * from C++
     * [`inline`](https://en.cppreference.com/w/c/language/inline)
     * mix declarations and code, declarations in the init clause of the for loop
       ```c
       /* invalid in C90, valid in C99 */
       int main()
       {
           printf("Hello!\n");
           float s = 0.0;
           for(int i = 0; i < 3; i++)
           {
              printf("type in number: ");
              float x = 0.0;
              scanf("%f", &x);
              s += x;
           }
           printf("sum = %f\n", s);
       }
       ```
     * `//` comments
     * [universal character names in source code](https://en.cppreference.com/w/c/language/escape)
  * removed implicit functions and implicit `int`
    ```c
    int main()
    {
        int a = 9;
        printf("%d\n", a); /* invalid in C99, no <stdio.h> */
        return fun();      /* invalid in C99, no fun declaration/definition*/
    }

    b = 11;                /* invalid in C99, no type in declaration */

    int fun()
    {
        printf("%d\n", b); /* invalid in C99, no <stdio.h> */
        return 0;
    }
    ```
* **2011**: [ISO/IEC 9899:2011](https://port70.net/~nsz/c/c11/n1570.pdf), `-std=c11`
  * [thread-aware memory model](https://en.cppreference.com/w/c/language/memory_model), [`stdatomic.h`](https://en.cppreference.com/w/c/atomic), [`threads.h`](https://en.cppreference.com/w/c/thread)
  * [type-generic functions](https://en.cppreference.com/w/c/language/generic)
  * [`alignas`](https://en.cppreference.com/w/c/language/_Alignas) / [`alignof`](https://en.cppreference.com/w/c/language/_Alignof)
  * [`noreturn`](https://en.cppreference.com/w/c/language/_Noreturn)
  * [`_Static_assert`](https://en.cppreference.com/w/c/language/_Static_assert)
  * [extensions to complex and imaginary types](https://en.cppreference.com/w/c/numeric/complex)
  * anonymous [structures](https://en.cppreference.com/w/c/language/struct) and [unions](https://en.cppreference.com/w/c/language/union)
  * [exclusive file open mode (`"x"`)](https://en.cppreference.com/w/c/io/fopen)
  * [`quick_exit`](https://en.cppreference.com/w/c/program/quick_exit)
  * removed [`gets`](https://en.cppreference.com/w/c/io/gets)
  * [bounds-checking interfaces](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1225.pdf) ([`strcpy_s`](https://en.cppreference.com/w/c/string/byte/strcpy) etc)
  * [unicode](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1040.pdf): `char16_t`, `char32_t`, and `uchar.h`
* **2017**: [ISO/IEC 9899:2018](https://files.lhmouse.com/standards/ISO%20C%20N2176.pdf), `-std=c17`
  * "bugfix release", the only difference between the options is the value of [`__STDC_VERSION__`](https://en.cppreference.com/w/c/preprocessor/replace#Predefined_macros)
* **development**: [C2X](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n2596.pdf), `-std=c2x`
  * [predefined boolean constants](https://en.cppreference.com/w/c/language/bool_constant)
  * [nullptr](https://en.cppreference.com/w/c/language/nullptr) and [nullptr_t](https://en.cppreference.com/w/c/types/nullptr_t)
  * [decimal IEEE-754 floating-point types](https://en.wikipedia.org/wiki/IEEE_754#Basic_and_interchange_formats): `_Decimal32`, `_Decimal64`, `_Decimal128`
  * from C++:
     * single-argument [`_Static_assert`](https://en.cppreference.com/w/c/language/_Static_assert)
     * attributes [`nodiscard`](https://en.cppreference.com/w/c/language/attributes/nodiscard), [`maybe_unused`](https://en.cppreference.com/w/c/language/attributes/maybe_unused), [`deprecated`](https://en.cppreference.com/w/c/language/attributes/deprecated), [`fallthrough`](https://en.cppreference.com/w/c/language/attributes/fallthrough)
     * [binary integer constant](https://en.cppreference.com/w/c/language/integer_constant)
     * [removal of old-style function definitions](https://en.cppreference.com/w/c/language/function_definition)
     * unnamed parameters in function definitions
  * library changes: POSIX functions [`memccpy`](https://en.cppreference.com/w/c/string/byte/memccpy), [`strdup`](https://en.cppreference.com/w/c/string/byte/strdup) / [`strndup`](https://en.cppreference.com/w/c/string/byte/strndup), [`asctime_r`](https://en.cppreference.com/w/c/chrono/asctime), [`ctime_r`](https://en.cppreference.com/w/c/chrono/ctime), [`gmtime_r`](https://en.cppreference.com/w/c/chrono/gmtime), [`localtime_r`](https://en.cppreference.com/w/c/chrono/localtime), [`strftime`](https://en.cppreference.com/w/c/chrono/strftime) / [`wcsftime`](https://en.cppreference.com/w/c/chrono/wcsftime) extensions; [`timespec_getres`](https://en.cppreference.com/w/c/chrono/timespec_getres)

[Обзор стандарта C23](https://youtu.be/ssuLCjRb9As)

[Some obscure C features](https://multun.net/obscure-c-features.html)

[Lambdas, Nested Functions, and Blocks, oh my!](https://thephd.dev/lambdas-nested-functions-block-expressions-oh-my)

[Why the C Language Will Never Stop You from Making Mistakes](https://thephd.dev/your-c-compiler-and-standard-library-will-not-help-you), [перевод](https://habr.com/ru/companies/otus/articles/747070)

[C Portability Lessons from Weird Machines](https://begriffs.com/posts/2018-11-15-c-portability.html), [H. Rabinowitz, Portable C](https://books.google.me/books/about/Portable_C.html?id=oEwiAQAAIAAJ)

[12 минут]::
## GNU расширения

[Extensions to the C Language Family (Using GCC)](https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html)

`-std=gnu90` / `-std=gnu99` / `-std=gnu11` / `-std=gnu17`


### Designated initializers
```c
int a[6] = { [4] = 29, [2] = 15 };

struct point { int x, y; };
struct point p = { .y = 2, .x = 1 };
```

### Function attributes

[Declaring Attributes of Functions (Using GCC)](https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html)

[Common Function Attributes (Using GCC)](https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html)

```c
int fn () __attribute__ ((warn_unused_result));
int foo ()
{
  if (fn () < 0) return -1;
  fn ();
  return 0;
}
```

---

```c
static int max(int x, int y) __attribute__((always_inline));
static int max(int x, int y)
{
    return x > y ? x : y; // always inline if possible
}
```

### Inline assembly
```c
#define DebugBreak() asm("int $3")
```

### Builtins

* [Vector extensions](https://gcc.gnu.org/onlinedocs/gcc/Vector-Extensions.html)
* [`__atomic` Builtins](https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html)
* [Interger Overflow Builtins](https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html)
* [Target Builtins](https://gcc.gnu.org/onlinedocs/gcc/Target-Builtins.html)
* [Other Builtins](https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html)

```c
if (__builtin_expect(ptr != NULL, 1))
  foo (*ptr);
```

### Case ranges
```c
case 'A' ... 'Z':
case 65 ... 90:
```

## Другие расширения

* [Clang language extensions](https://clang.llvm.org/docs/LanguageExtensions.html)
* [Microsoft extensions to C and C++](https://docs.microsoft.com/en-us/cpp/build/reference/microsoft-extensions-to-c-and-cpp)
  * [Unnamed fields (Using GCC)](https://gcc.gnu.org/onlinedocs/gcc/Unnamed-Fields.html)

[13 минут]::
## Unspecified & Undefined Behaviour
![With Undefined Behavior, Anything is Possible](anything_possible.jpg)
[With Undefined Behavior, Anything is Possible](https://raphlinus.github.io/programming/rust/2018/08/17/undefined-behavior.html)

[Неуточнённое поведение - Википедия](https://ru.wikipedia.org/wiki/Неуточнённое_поведение)

```c
#include <stdio.h>

int f() {
  printf("In f\n");
  return 3;
}

int g() {
  printf("In g\n");
  return 4;
}

int sum(int i, int j) {
  return i + j;
}

int main() {
  return sum(f(), g());
}
```

[Undefined behavior](https://en.wikipedia.org/wiki/Undefined_behavior)

```c
int arr[4] = {0, 1, 2, 3};
int *p = arr + 5;  // undefined behavior for indexing out of bounds
p = 0;
int a = *p;        // undefined behavior for dereferencing a null pointer
int i = 5;
i = ++i + ++i;     // undefined behavior for unsequenced modification and use of i
```

[Appendix J.1 и J.2 Стандарта](https://port70.net/~nsz/c/c99/n1256.pdf#page=501)

[Undefined behavior can result in time travel](https://devblogs.microsoft.com/oldnewthing/20140627-00/?p=633), [перевод](https://habr.com/ru/company/otus/blog/594557)

[Что каждый программист на C должен знать об Undefined Behavior](https://habr.com/ru/post/341048), [часть 2](https://habr.com/ru/post/341144), [часть 3](https://habr.com/ru/post/341154)

[Ещё раз о неопределённом поведении или «почему не стоит забивать гвозди бензопилой»](https://habr.com/ru/post/230777)

[Undefined behavior, and the Sledgehammer Principle](https://thephd.dev/c-undefined-behavior-and-the-sledgehammer-guideline)

[Undefined Behavior in 2017 - Embedded in Academia](https://blog.regehr.org/archives/1520)

[A Guide to Undefined Behavior in C and C++](https://blog.regehr.org/archives/213), [part 2](https://blog.regehr.org/archives/226), [part 3](https://blog.regehr.org/archives/232)

* **Spatial Memory Safety Violations**. Accessing out-of-bounds storage and even creating pointers to that storage are UB in C.
* **Temporal Memory Safety Violations**. Any use of a memory location after its lifetime has ended. This includes addresses of automatic variables outliving these variables; use-after-free, where a dangling pointer is accessed for reading or writing; and double free.
* **Integer Overflow**. Integers can overflow in both directions. Signed integer overflow is UB; this includes `INT_MIN / -1`, `INT_MIN % -1`, negating `INT_MIN`, shift with negative exponent, left-shifting a one past the sign bit, and (sometimes) left-shifting a one into the sign bit. Division by zero and shift by >= bitwidth are UB in both the signed and unsigned flavors.
* **Strict Aliasing Violations**. The "strict aliasing rules" in C standard allow the compiler to assume that if two pointers refer to different types, they cannot point to the same storage. This enables nice optimizations but risks breaking programs that take a flexible view of types.
* **Alignment Violations**. RISC-style processors have tended to disallow memory accesses where the address is not a multiple of the size of the object being accessed. On the other hand, C programs that use unaligned pointers are undefined regardless of the target architecture.
* **Loops that Neither Perform I/O nor Terminate**. A loop in C code that neither performs I/O nor terminates is undefined and can be terminated arbitrarily by the compiler.
* **Data Races**. A data race occurs when a piece of memory is accessed by more than one thread, at least one of the accesses is a store, and the accesses are not synchronized using a mechanism such as a lock. Data races are UB in modern flavor of C (there is no semantics in older versions since those standards do not address multithreaded code).
* **Unsequenced Modifications**. In C, "sequence points" constrain how early or late a side-effecting expression such as `x++` can take effect. Unsequenced modifications of the same value, or an unsequenced modification and use of the same value, results in UB.

[4 минуты]::
## Warnings

[Options to Request or Suppress Warnings](https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html)

* `-w`
  Inhibit all warning messages.

* `-Werror`
  Make all warnings into errors.

* `-Wpedantic` / `-pedantic`
  Issue all the warnings demanded by strict ISO C and ISO C++; reject all programs that use forbidden extensions, and some other programs that do not follow ISO C.

* `-Wall`
  This enables all the warnings about constructions that some users consider questionable, and that are easy to avoid (or modify to prevent the warning).
  Note that some warning flags are not implied by -Wall. Some of them warn about constructions that users generally do not consider questionable, but which occasionally you might wish to check for; others warn about constructions that are necessary or hard to avoid in some cases, and there is no simple way to modify the code to suppress the warning. Some of them are enabled by -Wextra but many of them must be enabled individually.

* `-Wextra`
  This enables some extra warning flags that are not enabled by `-Wall`.

[5 минут]::
## Нестандартные стандартные библиотеки

[Comparison of C/POSIX standard library implementations for Linux](http://www.etalabs.net/compare_libcs.html)

* [MSVCRT](https://docs.microsoft.com/en-us/cpp/c-runtime-library/c-run-time-library-reference)
* [FreeBSD libc](https://github.com/freebsd/freebsd-src/tree/master/lib/libc)
* [GNU libc](https://gnu.org/software/libc)
* [musl libc](https://musl.libc.org)
* [uClibc](https://uclibc.org/about.html), [uClibc-ng](https://uclibc-ng.org)
* [dietlibc](https://www.fefe.de/dietlibc)
* [Newlib](https://sourceware.org/newlib)
* [klibc](https://en.wikipedia.org/wiki/Klibc)
